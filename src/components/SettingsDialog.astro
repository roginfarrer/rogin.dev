---
import Box from "./Box.astro";
import Stack from "./Stack.astro";
import SettingsForm from "./SettingsForm.astro";
import { IoClose } from "react-icons/io5";
import * as styles from "./SettingsDialog.css";
---

<script>
  import { setupForm } from "./SettingsForm.astro";

  function setup(doc = document) {
    const dialog = doc.querySelector("#settings-dialog") as HTMLDialogElement;
    setupForm(dialog);

    function openModal() {
      dialog.showModal();
      doc.querySelector("body")!.style.setProperty("overflow", "hidden");
    }

    dialog.openModal = openModal;

    document
      .querySelector("#settings-dialog-close")
      ?.addEventListener("click", () => {
        dialog.close();
      });

    const dialogInner = document.querySelector(
      "#settings-dialog-inner",
    ) as HTMLDivElement;
    // Close modal
    dialog.addEventListener("touchend", (event) => {
      event.stopPropagation();
      doc.querySelector("body")!.style.removeProperty("overflow");
      dialog.close();
    });
    dialog.addEventListener("click", (event) => {
      doc.querySelector("body")!.style.removeProperty("overflow");
      dialog.close();
      event.stopPropagation();
    });
    // Don't close if touching inside modal
    dialogInner.addEventListener("touchend", (event) => {
      event.stopPropagation();
    });
    dialogInner.addEventListener("click", (event) => {
      event.stopPropagation();
    });
  }

  setup();

  document.addEventListener("astro:after-swap", () => {
    setup();
  });
</script>

<dialog id="settings-dialog" class={styles.dialog}>
  <Box id="settings-dialog-inner" p="$4">
    <Box
      position="absolute"
      top="$2"
      right="$2"
      as="button"
      id="settings-dialog-close"
      display="block"
      title="Close dialog"
      size="36px"
      display="flex"
      justifyContent="center"
      alignItems="center"
    >
      <IoClose size="1.25em" />
    </Box>
    <Stack gap="$3">
      <Box as="h2" typeScale="$2xl">Settings</Box>
      <SettingsForm />
    </Stack>
  </Box>
</dialog>
